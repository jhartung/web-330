<!--
============================================
; Title: Assignment 8.2
; Author: Professor Krasso
; Date: 24 February 2022
; Modified By: Joel Hartung
; Description: WhatABook, Part 2
; Code Attribution: HTML DOM Document addEventListener()
; URL: https://www.w3schools.com/jsref/met_document_addeventlistener.asp
; Code Attribution: JavaScript For Of Loop
; URL: https://www.w3schools.com/js/js_loop_forof.asp
; Code Attribution: DOMparser
; URL: https://developer.mozilla.org/en-US/docs/Web/API/DOMParser
; Code Attribution: Element.getElementsByTagName()
; URL: https://developer.mozilla.org/en-US/docs/Web/API/Element/getElementsByTagName
; Code Attribution: Document.querySelectorAll()
; URL: https://developer.mozilla.org/en-US/docs/Web/API/Document/querySelectorAll
; Code Attribution: Additional code from the Assignment 7 document
; Code Attribution: Additional code from the "WEB 330 HTML, CSS, and JavaScript Requirements" Document
;===========================================
-->

<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />

        <!-- CSS Links -->
        <link rel="stylesheet" type="text/css" href="../theme.css" />
        <link rel="stylesheet" type="text/css" href="../site.css" />
        <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@300;400;500;700&display=swap" rel="stylesheet" />

        <!-- Script Links -->
        <script src="../theme.js"></script>
        <!-- Site Title -->
        <title>WEB 330 - Enterprise JavaScript II</title>
    </head>
    <body class="light-theme">
        <!-- sets theme to light-theme -->
        <div class="assign-container">
            <h1 class="app-header">Welcome to the WhatABook, Part 2 App!</h1>
            <div class="assign-content">
                <div class="card">
                    <div class="card-title">Book Listing</div>
                    <div class="card-content" id="bookList">
                     
                    </div>
                </div>
                <br />
                <!-- Link to the home page -->
                <a href="../index.html" class="return-home">Return</a>
            </div>
        </div>
        <!-- results are posted to this container -->
        <div class="assign-container">
            <div class="assign-content">
                <div class="card">
                    <div class="card-title">Selected Book</div>
                    <div class="card-content" id="selectedBook"></div>
                </div>
            </div>
        </div>

        <script type="module">

            setSelectedTheme(); // sets the selected theme

            import { HttpClient } from "./http-client.js"; 
            
            let http = new HttpClient;
            
            let isbns = [
                "0345339681",
                "0261103571",
                "9780593099322",
                "9780261102361",
                "9780261102378",
                "9780590302715",
                "9780316769532",
                "9780743273565",
                "9780590405959"
            ];
            console.log(isbns);

            const params = {
                "bibkeys": `ISBN:${isbns.join(",")}`,
                "format": "json",
                "jscmd": "details"
            };
            console.log(params);

            http.get("https://openlibrary.org/api/books", params).then(res => {
               
                document.getElementById("bookList").innerHTML = buildHtmlString(res, "table");
                console.log(buildHtmlString);

                addIsbnClickEvents();
            })

            .catch(e => {
                console.log(e);
            })

            function getBooks(e) {
                e.preventDefault();

                let self = this;

                let isbn = self.innerText;

                const params = {
                    "bibkeys": `ISBN:${isbn}`,
                    "format": "json",
                    "jscmd": "details"
                };

                console.log(params);

                http.get("https://openlibrary.org/api/books", params).then(res => {
                    document.getElementById("selectedBook").innerHTML = buildHtmlString(res, "ul");
                 })

                .catch(e => {
                    console.log(e);
                })
            }

        function buildHtmlString(res, format) {
                let tableString = `
                <table id="bookTable" class="table">
                    <tr>
                        <th>ISBN</th>
                        <th>Title</th>
                        <th>Description</th>
                        <th>Pages</th>
                        <th>Authors</th>
                    </tr>`;

                let ulString = "";
                console.log(ulString);

                for (let key in res) {

                    ulString += "<ul>";
                    console.log(ulString);

                    if (res.hasOwnProperty(key)) {

                        let authors = [];

                        if (res[key].details.authors) {
                            authors = res[key].details.authors.map(function(author) {
                                return author.name;
                            })
                        }

                    let book = {
                        isbn: res[key].details.isbn_13 ? res[key].details.isbn_13 : res[key].details.isbn_10, // Note: ISBN formats are either "ISBN-13" or "ISBN-10" (older format) [Ref B].
                        title: res[key].details.title,
                        description: res[key].details.subtitle ? res[key].details.subtitle : "N/A",
                        pages: res[key].details.number_of_pages ? res[key].details.number_of_pages : "N/A",
                        authors: authors.join(", ")
                    }

                    ulString += `
                    <li><b>ISBN:</b> ${book.isbn}</li>
                    <li><b>Title:</b> ${book.title}</li>
                    <li><b>Description:</b> ${book.description}</li>
                    <li><b>Pages:</b> ${book.pages}</li>
                    <li><b>Authors:</b> ${book.authors}</li> 
                    `;
                    

                    tableString += `
                    <tr>
                        <td><a href="#" class="isbn-link">${book.isbn}</a></td>
                        <td>${book.title}</td>
                        <td>${book.description}</td>
                        <td>${book.pages}</td>
                        <td>${book.authors}</td>
                    </tr>
                    `;

                }
            }

            ulString += "</ul>";
            tableString += "</table>";

            if (format === "table") {
                return tableString;
            } else {
                return ulString;
            }
        }
    

        function addIsbnClickEvents() {
            let viewButtons = document.querySelectorAll("#bookTable tbody .isbn-link");

            for (let index= 0; index < viewButtons.length; index++) {
                let viewButton = viewButtons[index];
                viewButtons[index].addEventListener("click", getBooks);
            }
        }
              
        </script>
    </body>
</html>
